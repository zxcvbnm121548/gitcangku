<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
	<title>结算页</title>

	<link rel="stylesheet" type="text/css" href="/js/shop/css/webbase.css" />
	<link rel="stylesheet" type="text/css" href="/js/shop/css/pages-getOrderInfo.css" />
</head>

<body>
<!--head-->
<div id="navDiv"></div>
<div class="top">
	<div class="py-container">
		<div class="shortcut">
			<ul class="fl">
				<li class="f-item">品优购欢迎您！</li>
				<li class="f-item"><span><a href="/view/login.html">登录</a></span>&nbsp;<span><a href="#">免费注册</a></span></li>
			</ul>
			<ul class="fr">
				<li class="f-item">我的订单</li>
				<li class="f-item space"></li>
				<li class="f-item">我的品优购</li>
				<li class="f-item space"></li>
				<li class="f-item">品优购会员</li>
				<li class="f-item space"></li>
				<li class="f-item">企业采购</li>
				<li class="f-item space"></li>
				<li class="f-item">关注品优购</li>
				<li class="f-item space"></li>
				<li class="f-item">客户服务</li>
				<li class="f-item space"></li>
				<li class="f-item">网站导航</li>
			</ul>
		</div>
	</div>
</div>
<div class="cart py-container">
	<!--logoArea-->
	<div class="logoArea">
		<div class="fl logo"><span class="title">结算页</span></div>
		<div class="fr search">
			<form class="sui-form form-inline">
				<div class="input-append">
					<input type="text" type="text" class="input-error input-xxlarge" placeholder="品优购自营" />
					<button class="sui-btn btn-xlarge btn-danger" type="button">搜索</button>
				</div>
			</form>
		</div>
	</div>
	<!--主内容-->
	<div class="checkout py-container">
		<div class="checkout-tit">
			<h4 class="tit-txt">填写并核对订单信息</h4>
		</div>
		<div class="checkout-steps">
			<!--收件人信息-->
			<div class="step-tit">
				<h5>收件人信息<span><a data-toggle="modal" data-target=".edit" data-keyboard="false" class="newadd">新增收货地址</a></span></h5>
			</div>
			<div class="step-cont">
				<div class="addressInfo">
					<ul class="addr-detail">
						<li class="addr-item">
							<div id="cartArea" >

							</div>
						</li>
					</ul>
					<!--添加地址-->

					<div  tabindex="-1" role="dialog" data-hasfoot="false" class="sui-modal hide fade edit">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×</button>
									<h4 id="myModalLabel" class="modal-title">添加收货地址</h4>
								</div>
								<div class="modal-body">
									<form action="" class="sui-form form-horizontal">
										<div class="control-group">
											<label class="control-label">收货人：</label>
											<div class="controls">
												<input type="text" id="addName" class="input-medium">
											</div>
										</div>

										<div class="control-group">
											<label class="control-label">详细地址：</label>
											<div class="controls">
												<input type="text" id="addAreaName" class="input-large">
											</div>
										</div>
										<div class="control-group">
											<label class="control-label">选中默认地址：</label>
											<div class="controls">
												<input type="radio" name="addDefaultArea" value="1">是
												<input type="radio" name="addDefaultArea" value="0">否
											</div>
										</div>
										<div class="control-group">
											<label class="control-label">联系电话：</label>
											<div class="controls">
												<input type="text" id="addPhone" class="input-medium">
											</div>
										</div>
										<div class="control-group">
											<label class="control-label">邮箱：</label>
											<div class="controls">
												<input type="text" id="addEmail" class="input-medium">
											</div>
										</div>
										<div>
											<div class="othername">
												建议填写常用地址：<a href="#" class="sui-btn btn-default">家里</a>　<a href="#" class="sui-btn btn-default">父母家</a>　<a href="#" class="sui-btn btn-default">公司</a>
											</div>
										</div>

									</form>


								</div>
								<div class="modal-footer">
									<button type="button" data-ok="modal" onclick="addCartArea()" class="sui-btn btn-primary btn-large">确定</button>
									<button type="button" data-dismiss="modal" class="sui-btn btn-default btn-large">取消</button>
								</div>
							</div>
						</div>
					</div>
					<!--确认地址-->
				</div>
				<div class="hr"></div>

			</div>
			<div class="hr"></div>
			<!--支付和送货-->
			<div class="payshipInfo">
				<div class="step-tit">
					<h5>支付方式</h5>
				</div>
				<div class="step-cont">
					<ul class="payType">
						<li class="selected">微信付款<span title="点击取消选择"></span></li>
						<li>货到付款<span title="点击取消选择"></span></li>
					</ul>
				</div>
				<div class="hr"></div>
				<div class="step-tit">
					<h5>送货清单</h5>
				</div>

				<div class="cart-body" id="cartBody">

				</div>
				<div class="hr"></div>
			</div>
			<div class="linkInfo">
				<div class="step-tit">
					<h5>发票信息</h5>
				</div>
				<div class="step-cont">
					<span>普通发票（电子）</span>
					<span>个人</span>
					<span>明细</span>
				</div>
			</div>
			<div class="cardInfo">
				<div class="step-tit">
					<h5>使用优惠/抵用</h5>
				</div>
			</div>
		</div>
	</div>
	<div class="order-summary">
	</div>
	<div class="toolbar" id="barDiv">

	</div>
	<div class="clearfix trade" id="orderConfirmInfo">
		<div id="CartPrice2"></div>
		<div id="CartAreaDome1"></div>
	</div>
	<div class="submit">
		<a class="sui-btn btn-danger btn-xlarge" onclick="submitOrder()">提交订单</a>
	</div>
</div>
<!-- 底部栏位 -->
<div style="display: none" id="barTemp">
	<div class="static fr">
		<div class="list">
			<span><i class="number">##totalCount##</i>件商品，总商品金额</span>
			<em class="allprice">¥##totalPrice##</em>
		</div>
		<div class="list">
			<span>返现：</span>
			<em class="money">0.00</em>
		</div>
		<div class="list">
			<span>运费：</span>
			<em class="transport">0.00</em>
		</div>
	</div>
</div>
<!--页面底部-->
<div class="clearfix footer">
	<div class="py-container">
		<div class="footlink">
			<div class="Mod-service">
				<ul class="Mod-Service-list">
					<li class="grid-service-item intro  intro1">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item  intro intro2">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item intro  intro3">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item  intro intro4">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item intro intro5">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
				</ul>
			</div>
			<div class="clearfix Mod-list">
				<div class="yui3-g">
					<div class="yui3-u-1-6">
						<h4>购物指南</h4>
						<ul class="unstyled">
							<li>购物流程</li>
							<li>会员介绍</li>
							<li>生活旅行/团购</li>
							<li>常见问题</li>
							<li>购物指南</li>
						</ul>

					</div>
					<div class="yui3-u-1-6">
						<h4>配送方式</h4>
						<ul class="unstyled">
							<li>上门自提</li>
							<li>211限时达</li>
							<li>配送服务查询</li>
							<li>配送费收取标准</li>
							<li>海外配送</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>支付方式</h4>
						<ul class="unstyled">
							<li>货到付款</li>
							<li>在线支付</li>
							<li>分期付款</li>
							<li>邮局汇款</li>
							<li>公司转账</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>售后服务</h4>
						<ul class="unstyled">
							<li>售后政策</li>
							<li>价格保护</li>
							<li>退款说明</li>
							<li>返修/退换货</li>
							<li>取消订单</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>特色服务</h4>
						<ul class="unstyled">
							<li>夺宝岛</li>
							<li>DIY装机</li>
							<li>延保服务</li>
							<li>品优购E卡</li>
							<li>品优购通信</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
					</div>
				</div>
			</div>
			<div class="Mod-copyright">
				<ul class="helpLink">
					<li>关于我们<span class="space"></span></li>
					<li>联系我们<span class="space"></span></li>
					<li>关于我们<span class="space"></span></li>
					<li>商家入驻<span class="space"></span></li>
					<li>营销中心<span class="space"></span></li>
					<li>友情链接<span class="space"></span></li>
					<li>关于我们<span class="space"></span></li>
					<li>营销中心<span class="space"></span></li>
					<li>友情链接<span class="space"></span></li>
					<li>关于我们</li>
				</ul>
			</div>
		</div>
	</div>
</div>
<!-- 收货人信息 -->
<div style="display: none" id="cartDivList">
	<div class="con name " onclick="checkno('##id##')" id="v_##id##"><a href="javascript:;" >##name##<span title="点击取消选择">&nbsp;</a>
	</div>
	<div class="con address" id="cartname">##name## ##areaName## <span>##phone##</span>
		<input type="hidden" id="checkId" value="cartArea##id##">
		<a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;" onclick="deleteCartArea('##id##')">删除</a>
	</div>
	<div class="clearfix"></div>
</div>

<!-- 结算信息-->、
<div style="display: none">
	<div class="fc-price" id="CartPrice1">应付金额:<span class="price">¥##totalPrice##</span></div>
	<div class="fc-receiverInfo" id="CartAreaDome">寄送至: ##AreaName## 收货人：##Name## ##Phone##</div>
</div>
<!-- 订单信息 -->
<script type="text/html" id="showCart">
	<div class="sendGoods">
		<ul class="yui3-g">
			<li class="yui3-u-1-6">
				<!--<span><img src="img/goods.png"/></span>-->
				<span><img src="http://192.168.225.128:80/##mainImage##" width="50px"/></span>
			</li>
			<li class="yui3-u-7-12">
				<div class="item-msg">##produtName##</div>
				<div class="seven">7天无理由退货</div>
			</li>
			<li class="yui3-u-1-12">
				<div class="price">￥##subTotalPrice##</div>
			</li>
			<li class="yui3-u-1-12">
				<div class="num">X##count##</div>
			</li>
			<li class="yui3-u-1-12">
				<div class="exit">剩余##subTotalCount##件</div>
			</li>
		</ul>
	</div>
</script>


<!--页面底部END-->
<script src="/js/jquery-3.3.1.js"></script>
<script src="/js/bootstrap/js/bootstrap.min.js"></script>
<script src="/js/jquery.cookie.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/sui/sui.min.js"></script>
<script type="text/javascript" src="/js/shop/js/pages/getOrderInfo.js"></script>
<script src="/js/common/nav3.js"></script>
</body>
<script>

    $(function () {
        getToken();
        $("#cartDivList > div").removeClass("selected");
        queryListCartArea();
        initCart(indexedDB);
        checkno();
    });
    
    function getToken() {
		$.post(
		    "http://localhost:8082/token/getToken",
			function (data) {
				if(data.status==200){
				    mtoken = data.data;
				}
            }
		)
    }
    
    function initCart(){
        if(isLogin){
            $.post(
                "http://localhost:8082/cart/findCartList",
                function (data) {
                    if(data.status==200){
                        var list =data.data.cartItemList;
                        var showTeml = "";
                        for (var i = 0; i < list.length; i++) {
                            var htmlTemp =$("#showCart").html();
                            var aaa= list[i];
                            showTeml +=    htmlTemp.replace(/##produtName##/g,aaa.productName).
                            replace(/##mainImage##/g,aaa.filePath).
                            replace(/##subTotalCount##/g,aaa.subTotalCount).
                            replace(/##count##/g,aaa.count).
                            replace(/##subTotalPrice##/g,aaa.subTotalPrice);
                        }
                        $("#cartBody").html(showTeml);
                        var barTemp =  $("#barTemp").html();
                        var barhtml =  barTemp.replace(/##totalCount##/g,data.data.totalCount)
                            .replace(/##totalPrice##/g,data.data.totalPrice);
                        $("#barDiv").html(barhtml);
                        var cartPrice1 = $("#CartPrice1").html();
                        var cloceDiv = cartPrice1.replace(/##totalPrice##/g,data.data.totalPrice);
                        $("#CartPrice2").html(cloceDiv);
                    }
                }
            )
        }
    }

var address_id = 0;
    function checkno(id) {
       // location.reload();
        $("#cartDivList > div").removeClass("selected");
        $("#v_"+ id ).addClass("selected");
        var value = $("#v_"+id).val();
        //$("#cartArea").html(value);
        address_id = id;

    }

    function queryListCartArea() {
        $.post(
            "http://localhost:8082/cartArea/queryListCartArea",
            function (result) {
                if(result.succecc==200){
                    var cartAreaList = result.data;
                    var a="";
                    for (var i = 0; i < cartAreaList.length; i++) {
                        var cartArea = cartAreaList[i];
                            cartDivList1 =$("#cartDivList").html()
                                .replace(/##id##/g,cartArea.id)
                                .replace(/##name##/g,cartArea.name)
                                .replace(/##areaName##/g,cartArea.areaName)
                                .replace(/##id##/g,cartArea.id)
                                .replace(/##phone##/g,cartArea.phone);

                            $("#cartArea").append(cartDivList1);
                        if(cartArea.defaultArea==1){
                            checkno(cartArea.id);
                            $("#cartname").append('<span class="base">默认地址</span>');
                            a= $("#CartAreaDome").html().replace(/##Name##/g,cartArea.name)
                                .replace(/##AreaName##/g,cartArea.areaName)
                                .replace(/##Phone##/g,cartArea.phone);
                        }
                    }
                    $("#CartAreaDome1").html(a)

                }
            }
        )
    }
    function deleteCartArea(id) {
        $.post(
            "http://localhost:8082/cartArea/deleteCartArea.do",
            {"id":id},
            function (result) {
                if(result.succecc==200){
                    $("#cartArea").html("");
                    queryListCartArea();
                }
            }
        )
    }
    function addCartArea() {
        var cartArea = {};
        cartArea.name = $("#addName").val();
        cartArea.areaName = $("#addAreaName").val();
        cartArea.phone = $("#addPhone").val();
        cartArea.email = $("#addEmail").val();
        cartArea.defaultArea = $("[name='addDefaultArea']:checked").val();
        cartArea.address = 1;
        $.post(
            "http://localhost:8082/cartArea/addCartArea",
            cartArea,
            function (result) {
                if(result.succecc==200){
                    $("#cartArea").html("");
                    queryListCartArea();
                }

            }
        )
    }


    /* 提交订单 */
	function submitOrder() {
	    $.ajax({
			url:"http://localhost:8082/order/buildOrder",
			type:"post",
			dataType:"json",
			data:{"payType":1,"addressId":address_id},
            beforeSend: function(xhr) {
                var token = window.localStorage.getItem("token");
                xhr.setRequestHeader("x-auth", token);
                xhr.setRequestHeader("mtoken", mtoken);
            },
            success:function(data){
                if(data.status == 200){
                    var shortList = data.data;
                    if (shortList.length==0){
                        location.href="/view/pay.html";
                    }else {
                        var str = "" ;
                        for (var i=0; i<shortList.length;i++){
                            var goods = shortList[i];
                            str += goods.productName+","
                        }

                    }

                } else{
                    alert(data.msg)
				}

            }
		});
    }
</script>

</html>